# Постановка задачи
В упрощенном виде задача звучит как: пользователь загружает HTML файл и получает в ответ HTML преобразованный в PDF. Важно, что файлы могут быть большими, обрабатываться долго, причем достаточно долго что бы возникла проблема на стороне сервера. Пользователь не должен получить сбой при перезагрузке веб-сервисов. Дополнительное направление атаки — это обеспечение масштабирования, простоты эксплуатации и возможности дальнейшего развития. Термин масштабирование очень скользкий, так как не всегда ясно что заказчик имел ввиду, масштабирование с целью увеличения допустимой нагрузки на программный комплекс, или масштабирование в смысле наращивания функционала. Поэтому при реализации разрезали проект на несколько независимых продуктов, которые позволяют наращивать производительность, а также добавлять функционал.

Необходимо использовать стек C# на стороне сервера и REACT или VUE на стороне клиента.

# Предисловие к выполнению
Так как в резюме я громко заявил [«мне без разницы какой будет стек, сделаем на любом!!!»](https://tikhoretsk.hh.ru/resume/87d5ffe9ff0bc8448a0039ed1f77394d787931) пришлось отвечать за свои слова, и я впервые в жизни написал клиента на react.js. Выбор между react и vue лежал в плоскости наименьшего урона моему АРМ, но так как наносимый урон примерно одинаков то выбор осуществлялся с помощью монетки.

# Как это работает
![scr](/scr_01.jpg)
Пользователь через WEB интерфейс выбирает файл для преобразование (левая кнопочка) после чего нажимает кнопочку «загрузить». После этого DFP.API комплекса размещает файл в внутренней базе данных. Фоновый процесс (DFP.SERVIVE) берет данный файл в обработку и выполняет преобразование. После завершения преобразования результат преобразования размещается в БД. Через WEB интерфейс пользователь может скачать данный файл.

На каждом этапе действий обновляется информация о состоянии преобразования файла, в частности жизненный этап выполнения преобразования разбит на следующие этапы:
-	**Upload** – файл загружен и готов к преобразованию
-	**Process** – сервис преобразования начал обработку файла
-	**Ready** – преобразование файла завершено и пользователь может скачать результат
-	**Error** – ошибка в обработке файла, возможно пользователь загрузил пустой файл (пара сотен пробелов считаются пустым файлом), или при конвертации возникли проблемы. Данный статус означает что файл не получилось преобразовать и это уже не изменится.

Для каждого жизненного этапа сохраняется время и дата начала этапа. Данный маневр позволяет объективно контролировать быстродействие сервиса, т.е. мы можем получить объективные данные: среднее время ожидания файла в очереди, среднее время преобразования файла.

# Состав программного комплекса
**client** – непосредственно web интерфейс который видит пользователь. Там ничего не делается, только выполняется отправка файла на сервер, и отображение состояния загруженных файлов.
**DFP.CORE** – проект базы данных программного комплекса, содержит описание сущностей данных комплекса.
**DFP.API** – служба обработки HTTP запросов. Выполняет принятие файлов от пользователей (upload), предоставляет информацию пользователям о статусе отправленных файлов на обработку. Интерфейс получения результатов обработки.
**DFP.SERVICE** – служба выполнения фоновых задач. Выполняет циклический мониторинг базы данных, и в случае обнаружения новых загруженных файлов выполняет их преобразование.

# Известные проблемы

1. Отслеживание отправки файла не реализовано, т.е. нужно в веб-интерфейсе отображать на сколько процентов файл загрузился. Так же не отображается информация о успешной/неуспешной загрузке файла на сервер.
1. Не реализована авторизация пользователей. Т.е. в БД не указывается кто загрузил файл, и как следствие не реализован функционал отображения пользователю только тех файлов, которые он загрузил. На данный момент отображаются файлы всех пользователей всем пользователям.
1. Не реализованы уведомления в браузере (или по другим каналам в случае off-line пользователя) о окончании преобразования его файла.
1. Список файлов отображается полностью, разбиение на страницы не выполнено.
1. Стратегия очистки очереди не реализована, т.е. необходим отдельный поток, который удаляет старые файлы. Т.е. там нужно как минимум реализовать два времени жизни готовых файлов: для файлов, которые скачали и для файлов, которые еще не скачали. Так же при реализации авторизации пользователя возможны дополнительные нюансы в виде платной подписки длительного хранения файлов.
1. Стратегия сброса «зависших файлов». Т.е. вполне возможно, что некоторые файлы будут зависать в состоянии «обработка» хотя обработка уже не выполняется. Эта ситуация возникает в случае жесткой перезагрузки службы обработки. Для этого необходимо добавить еще один поток, который следит за временем, которое прошло с момента начала преобразования, и если оно большое, то файл сбрасывается в состояние upload и процесс преобразования будет снова инициализирован в порядке очереди.
1. Масштабирование очереди. При масштабировании путем увеличения активных потоков преобразования файлов, необходимо выполнять пометку о извлечении файла для обработки на стороне сервера баз данных, скриптом который выполняет обновление данных с проверкой «а вдруг другой поток на пару миллисекунд оказался быстрее, и уже забрал этот файл в работу».
